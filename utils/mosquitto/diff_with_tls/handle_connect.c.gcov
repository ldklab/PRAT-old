134c134
<     #####:  132:	X509 *client_cert = NULL;
---
>         -:  132:	X509 *client_cert = NULL;
137c137
<     #####:  135:	ASN1_STRING *name_asn1 = NULL;
---
>         -:  135:	ASN1_STRING *name_asn1 = NULL;
411c411
<     #####:  409:	if(context->listener && context->listener->ssl_ctx && (context->listener->use_identity_as_username || context->listener->use_subject_as_username)){
---
>         -:  409:	if(context->listener && context->listener->ssl_ctx && (context->listener->use_identity_as_username || context->listener->use_subject_as_username)){
413,416c413,416
<     #####:  411:		mosquitto__free(username);
<     #####:  412:		username = NULL;
<     #####:  413:		mosquitto__free(password);
<     #####:  414:		password = NULL;
---
>         -:  411:		mosquitto__free(username);
>         -:  412:		username = NULL;
>         -:  413:		mosquitto__free(password);
>         -:  414:		password = NULL;
418,421c418,421
<     #####:  416:		if(!context->ssl){
<     #####:  417:			send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
<     #####:  418:			rc = 1;
<     #####:  419:			goto handle_connect_error;
---
>         -:  416:		if(!context->ssl){
>         -:  417:			send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
>         -:  418:			rc = 1;
>         -:  419:			goto handle_connect_error;
424c424
<     #####:  422:		if(context->listener->psk_hint){
---
>         -:  422:		if(context->listener->psk_hint){
426,429c426,429
<     #####:  424:			if(!context->username){
<     #####:  425:				send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
<     #####:  426:				rc = 1;
<     #####:  427:				goto handle_connect_error;
---
>         -:  424:			if(!context->username){
>         -:  425:				send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
>         -:  426:				rc = 1;
>         -:  427:				goto handle_connect_error;
433,437c433,437
<     #####:  431:			client_cert = SSL_get_peer_certificate(context->ssl);
<     #####:  432:			if(!client_cert){
<     #####:  433:				send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
<     #####:  434:				rc = 1;
<     #####:  435:				goto handle_connect_error;
---
>         -:  431:			client_cert = SSL_get_peer_certificate(context->ssl);
>         -:  432:			if(!client_cert){
>         -:  433:				send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
>         -:  434:				rc = 1;
>         -:  435:				goto handle_connect_error;
439,443c439,443
<     #####:  437:			name = X509_get_subject_name(client_cert);
<     #####:  438:			if(!name){
<     #####:  439:				send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
<     #####:  440:				rc = 1;
<     #####:  441:				goto handle_connect_error;
---
>         -:  437:			name = X509_get_subject_name(client_cert);
>         -:  438:			if(!name){
>         -:  439:				send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
>         -:  440:				rc = 1;
>         -:  441:				goto handle_connect_error;
445,450c445,450
<     #####:  443:			if (context->listener->use_identity_as_username) { //use_identity_as_username
<     #####:  444:				i = X509_NAME_get_index_by_NID(name, NID_commonName, -1);
<     #####:  445:				if(i == -1){
<     #####:  446:					send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
<     #####:  447:					rc = 1;
<     #####:  448:					goto handle_connect_error;
---
>         -:  443:			if (context->listener->use_identity_as_username) { //use_identity_as_username
>         -:  444:				i = X509_NAME_get_index_by_NID(name, NID_commonName, -1);
>         -:  445:				if(i == -1){
>         -:  446:					send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
>         -:  447:					rc = 1;
>         -:  448:					goto handle_connect_error;
452,458c452,458
<     #####:  450:				name_entry = X509_NAME_get_entry(name, i);
<     #####:  451:				if(name_entry){
<     #####:  452:					name_asn1 = X509_NAME_ENTRY_get_data(name_entry);
<     #####:  453:					if (name_asn1 == NULL) {
<     #####:  454:						send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
<     #####:  455:						rc = 1;
<     #####:  456:						goto handle_connect_error;
---
>         -:  450:				name_entry = X509_NAME_get_entry(name, i);
>         -:  451:				if(name_entry){
>         -:  452:					name_asn1 = X509_NAME_ENTRY_get_data(name_entry);
>         -:  453:					if (name_asn1 == NULL) {
>         -:  454:						send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
>         -:  455:						rc = 1;
>         -:  456:						goto handle_connect_error;
463c463
<     #####:  461:					context->username = mosquitto__strdup((char *) ASN1_STRING_get0_data(name_asn1));
---
>         -:  461:					context->username = mosquitto__strdup((char *) ASN1_STRING_get0_data(name_asn1));
465,468c465,468
<     #####:  463:					if(!context->username){
<     #####:  464:						send__connack(context, 0, CONNACK_REFUSED_SERVER_UNAVAILABLE);
<     #####:  465:						rc = MOSQ_ERR_NOMEM;
<     #####:  466:						goto handle_connect_error;
---
>         -:  463:					if(!context->username){
>         -:  464:						send__connack(context, 0, CONNACK_REFUSED_SERVER_UNAVAILABLE);
>         -:  465:						rc = MOSQ_ERR_NOMEM;
>         -:  466:						goto handle_connect_error;
471,474c471,474
<     #####:  469:					if ((size_t)ASN1_STRING_length(name_asn1) != strlen(context->username)) {
<     #####:  470:						send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
<     #####:  471:						rc = 1;
<     #####:  472:						goto handle_connect_error;
---
>         -:  469:					if ((size_t)ASN1_STRING_length(name_asn1) != strlen(context->username)) {
>         -:  470:						send__connack(context, 0, CONNACK_REFUSED_BAD_USERNAME_PASSWORD);
>         -:  471:						rc = 1;
>         -:  472:						goto handle_connect_error;
478,486c478,486
<     #####:  476:				BIO *subject_bio = BIO_new(BIO_s_mem());
<     #####:  477:				X509_NAME_print_ex(subject_bio, X509_get_subject_name(client_cert), 0, XN_FLAG_RFC2253);
<     #####:  478:				char *data_start = NULL;
<     #####:  479:				long name_length = BIO_get_mem_data(subject_bio, &data_start);
<     #####:  480:				char *subject = mosquitto__malloc(sizeof(char)*name_length+1);
<     #####:  481:				if(!subject){
<     #####:  482:					BIO_free(subject_bio);
<     #####:  483:					rc = MOSQ_ERR_NOMEM;
<     #####:  484:					goto handle_connect_error;
---
>         -:  476:				BIO *subject_bio = BIO_new(BIO_s_mem());
>         -:  477:				X509_NAME_print_ex(subject_bio, X509_get_subject_name(client_cert), 0, XN_FLAG_RFC2253);
>         -:  478:				char *data_start = NULL;
>         -:  479:				long name_length = BIO_get_mem_data(subject_bio, &data_start);
>         -:  480:				char *subject = mosquitto__malloc(sizeof(char)*name_length+1);
>         -:  481:				if(!subject){
>         -:  482:					BIO_free(subject_bio);
>         -:  483:					rc = MOSQ_ERR_NOMEM;
>         -:  484:					goto handle_connect_error;
488,491c488,491
<     #####:  486:				memcpy(subject, data_start, name_length);
<     #####:  487:				subject[name_length] = '\0';
<     #####:  488:				BIO_free(subject_bio);
<     #####:  489:				context->username = subject;
---
>         -:  486:				memcpy(subject, data_start, name_length);
>         -:  487:				subject[name_length] = '\0';
>         -:  488:				BIO_free(subject_bio);
>         -:  489:				context->username = subject;
493c493
<     #####:  491:			if(!context->username){
---
>         -:  491:			if(!context->username){
497,498c497,498
<     #####:  495:			X509_free(client_cert);
<     #####:  496:			client_cert = NULL;
---
>         -:  495:			X509_free(client_cert);
>         -:  496:			client_cert = NULL;
686c686
<     #####:  684:	if(client_cert) X509_free(client_cert);
---
>         -:  684:	if(client_cert) X509_free(client_cert);
689c689
<         -:  687:	return rc;
---
>     #####:  687:	return rc;
