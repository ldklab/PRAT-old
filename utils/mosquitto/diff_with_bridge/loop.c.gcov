185,194c185,194
<     #####:  183:	HASH_ITER(hh_sock, db->contexts_by_sock, context, ctxt_tmp){
<     #####:  184:		if(context->bridge){
<     #####:  185:			ev.data.fd = context->sock;
<     #####:  186:			ev.events = EPOLLIN;
<     #####:  187:			context->events = EPOLLIN;
<     #####:  188:			if (epoll_ctl(db->epollfd, EPOLL_CTL_ADD, context->sock, &ev) == -1) {
<     #####:  189:				log__printf(NULL, MOSQ_LOG_ERR, "Error in epoll initial registering bridge: %s", strerror(errno));
<     #####:  190:				(void)close(db->epollfd);
<     #####:  191:				db->epollfd = 0;
<     #####:  192:				return MOSQ_ERR_UNKNOWN;
---
>         -:  183:	HASH_ITER(hh_sock, db->contexts_by_sock, context, ctxt_tmp){
>         -:  184:		if(context->bridge){
>         -:  185:			ev.data.fd = context->sock;
>         -:  186:			ev.events = EPOLLIN;
>         -:  187:			context->events = EPOLLIN;
>         -:  188:			if (epoll_ctl(db->epollfd, EPOLL_CTL_ADD, context->sock, &ev) == -1) {
>         -:  189:				log__printf(NULL, MOSQ_LOG_ERR, "Error in epoll initial registering bridge: %s", strerror(errno));
>         -:  190:				(void)close(db->epollfd);
>         -:  191:				db->epollfd = 0;
>         -:  192:				return MOSQ_ERR_UNKNOWN;
235,240c235,240
<     #####:  233:				if(context->bridge){
<     #####:  234:					mosquitto__check_keepalive(db, context);
<     #####:  235:					if(context->bridge->round_robin == false
<     #####:  236:							&& context->bridge->cur_address != 0
<     #####:  237:							&& context->bridge->primary_retry
<     #####:  238:							&& now > context->bridge->primary_retry){
---
>         -:  233:				if(context->bridge){
>         -:  234:					mosquitto__check_keepalive(db, context);
>         -:  235:					if(context->bridge->round_robin == false
>         -:  236:							&& context->bridge->cur_address != 0
>         -:  237:							&& context->bridge->primary_retry
>         -:  238:							&& now > context->bridge->primary_retry){
242,244c242,244
<     #####:  240:						if(context->bridge->primary_retry_sock == INVALID_SOCKET){
<     #####:  241:							rc = net__try_connect(context, context->bridge->addresses[0].address,
<     #####:  242:									context->bridge->addresses[0].port,
---
>         -:  240:						if(context->bridge->primary_retry_sock == INVALID_SOCKET){
>         -:  241:							rc = net__try_connect(context, context->bridge->addresses[0].address,
>         -:  242:									context->bridge->addresses[0].port,
247,252c247,252
<     #####:  245:							if(rc == 0){
<     #####:  246:								COMPAT_CLOSE(context->bridge->primary_retry_sock);
<     #####:  247:								context->bridge->primary_retry_sock = INVALID_SOCKET;
<     #####:  248:								context->bridge->primary_retry = 0;
<     #####:  249:								net__socket_close(db, context);
<     #####:  250:								context->bridge->cur_address = 0;
---
>         -:  245:							if(rc == 0){
>         -:  246:								COMPAT_CLOSE(context->bridge->primary_retry_sock);
>         -:  247:								context->bridge->primary_retry_sock = INVALID_SOCKET;
>         -:  248:								context->bridge->primary_retry = 0;
>         -:  249:								net__socket_close(db, context);
>         -:  250:								context->bridge->cur_address = 0;
255,262c255,262
<     #####:  253:							len = sizeof(int);
<     #####:  254:							if(!getsockopt(context->bridge->primary_retry_sock, SOL_SOCKET, SO_ERROR, (char *)&err, &len)){
<     #####:  255:								if(err == 0){
<     #####:  256:									COMPAT_CLOSE(context->bridge->primary_retry_sock);
<     #####:  257:									context->bridge->primary_retry_sock = INVALID_SOCKET;
<     #####:  258:									context->bridge->primary_retry = 0;
<     #####:  259:									net__socket_close(db, context);
<     #####:  260:									context->bridge->cur_address = context->bridge->address_count-1;
---
>         -:  253:							len = sizeof(int);
>         -:  254:							if(!getsockopt(context->bridge->primary_retry_sock, SOL_SOCKET, SO_ERROR, (char *)&err, &len)){
>         -:  255:								if(err == 0){
>         -:  256:									COMPAT_CLOSE(context->bridge->primary_retry_sock);
>         -:  257:									context->bridge->primary_retry_sock = INVALID_SOCKET;
>         -:  258:									context->bridge->primary_retry = 0;
>         -:  259:									net__socket_close(db, context);
>         -:  260:									context->bridge->cur_address = context->bridge->address_count-1;
264,266c264,266
<     #####:  262:									COMPAT_CLOSE(context->bridge->primary_retry_sock);
<     #####:  263:									context->bridge->primary_retry_sock = INVALID_SOCKET;
<     #####:  264:									context->bridge->primary_retry = now+5;
---
>         -:  262:									COMPAT_CLOSE(context->bridge->primary_retry_sock);
>         -:  263:									context->bridge->primary_retry_sock = INVALID_SOCKET;
>         -:  264:									context->bridge->primary_retry = now+5;
269,271c269,271
<     #####:  267:								COMPAT_CLOSE(context->bridge->primary_retry_sock);
<     #####:  268:								context->bridge->primary_retry_sock = INVALID_SOCKET;
<     #####:  269:								context->bridge->primary_retry = now+5;
---
>         -:  267:								COMPAT_CLOSE(context->bridge->primary_retry_sock);
>         -:  268:								context->bridge->primary_retry_sock = INVALID_SOCKET;
>         -:  269:								context->bridge->primary_retry = now+5;
341,342c341,342
<     #####:  339:		for(i=0; i<db->bridge_count; i++){
<     #####:  340:			if(!db->bridges[i]) continue;
---
>         -:  339:		for(i=0; i<db->bridge_count; i++){
>         -:  340:			if(!db->bridges[i]) continue;
344c344
<     #####:  342:			context = db->bridges[i];
---
>         -:  342:			context = db->bridges[i];
346,348c346,348
<     #####:  344:			if(context->sock == INVALID_SOCKET){
<     #####:  345:				if(time_count > 0){
<     #####:  346:					time_count--;
---
>         -:  344:			if(context->sock == INVALID_SOCKET){
>         -:  345:				if(time_count > 0){
>         -:  346:					time_count--;
350,351c350,351
<     #####:  348:					time_count = 1000;
<     #####:  349:					now = mosquitto_time();
---
>         -:  348:					time_count = 1000;
>         -:  349:					now = mosquitto_time();
354,358c354,358
<     #####:  352:				if(!context->bridge->restart_t){
<     #####:  353:					context->bridge->restart_t = now+context->bridge->restart_timeout;
<     #####:  354:					context->bridge->cur_address++;
<     #####:  355:					if(context->bridge->cur_address == context->bridge->address_count){
<     #####:  356:						context->bridge->cur_address = 0;
---
>         -:  352:				if(!context->bridge->restart_t){
>         -:  353:					context->bridge->restart_t = now+context->bridge->restart_timeout;
>         -:  354:					context->bridge->cur_address++;
>         -:  355:					if(context->bridge->cur_address == context->bridge->address_count){
>         -:  356:						context->bridge->cur_address = 0;
361,362c361,362
<     #####:  359:					if((context->bridge->start_type == bst_lazy && context->bridge->lazy_reconnect)
<     #####:  360:							|| (context->bridge->start_type == bst_automatic && now > context->bridge->restart_t)){
---
>         -:  359:					if((context->bridge->start_type == bst_lazy && context->bridge->lazy_reconnect)
>         -:  360:							|| (context->bridge->start_type == bst_automatic && now > context->bridge->restart_t)){
432,436c432,436
<     #####:  430:							rc = bridge__connect(db, context);
<     #####:  431:							context->bridge->restart_t = 0;
<     #####:  432:							if(rc == MOSQ_ERR_SUCCESS){
<     #####:  433:								if(context->bridge->round_robin == false && context->bridge->cur_address != 0){
<     #####:  434:									context->bridge->primary_retry = now + 5;
---
>         -:  430:							rc = bridge__connect(db, context);
>         -:  431:							context->bridge->restart_t = 0;
>         -:  432:							if(rc == MOSQ_ERR_SUCCESS){
>         -:  433:								if(context->bridge->round_robin == false && context->bridge->cur_address != 0){
>         -:  434:									context->bridge->primary_retry = now + 5;
439,442c439,442
<     #####:  437:								ev.data.fd = context->sock;
<     #####:  438:								ev.events = EPOLLIN;
<     #####:  439:								if(context->current_out_packet){
<     #####:  440:									ev.events |= EPOLLOUT;
---
>         -:  437:								ev.data.fd = context->sock;
>         -:  438:								ev.events = EPOLLIN;
>         -:  439:								if(context->current_out_packet){
>         -:  440:									ev.events |= EPOLLOUT;
444,446c444,446
<     #####:  442:								if(epoll_ctl(db->epollfd, EPOLL_CTL_ADD, context->sock, &ev) == -1) {
<     #####:  443:									if((errno != EEXIST)||(epoll_ctl(db->epollfd, EPOLL_CTL_MOD, context->sock, &ev) == -1)) {
<     #####:  444:											log__printf(NULL, MOSQ_LOG_DEBUG, "Error in epoll re-registering bridge: %s", strerror(errno));
---
>         -:  442:								if(epoll_ctl(db->epollfd, EPOLL_CTL_ADD, context->sock, &ev) == -1) {
>         -:  443:									if((errno != EEXIST)||(epoll_ctl(db->epollfd, EPOLL_CTL_MOD, context->sock, &ev) == -1)) {
>         -:  444:											log__printf(NULL, MOSQ_LOG_DEBUG, "Error in epoll re-registering bridge: %s", strerror(errno));
449c449
<     #####:  447:									context->events = ev.events;
---
>         -:  447:									context->events = ev.events;
462,464c462,464
<     #####:  460:								context->bridge->cur_address++;
<     #####:  461:								if(context->bridge->cur_address == context->bridge->address_count){
<     #####:  462:									context->bridge->cur_address = 0;
---
>         -:  460:								context->bridge->cur_address++;
>         -:  461:								if(context->bridge->cur_address == context->bridge->address_count){
>         -:  462:									context->bridge->cur_address = 0;
674c674
<     #####:  672:		if(context->clean_session && !context->bridge){
---
>         -:  672:		if(context->clean_session && !context->bridge){
676c676
<         -:  674:		if(context->clean_session){
---
>     #####:  674:		if(context->clean_session){
